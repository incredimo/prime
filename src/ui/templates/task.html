<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite AI - Task Details</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar {
            background-color: #343a40 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        
        .terminal {
            background-color: #212529;
            color: #cccccc;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            height: calc(100vh - 250px);
            position: relative;
        }
        
        .terminal-toolbar {
            position: sticky;
            top: 0;
            background-color: #212529;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-badge {
            font-size: 0.85em;
            padding: 0.4em 0.7em;
            border-radius: 50rem;
        }
        
        .status-running { background-color: #007bff; color: white; }
        .status-completed { background-color: #28a745; color: white; }
        .status-failed { background-color: #dc3545; color: white; }
        .status-waiting { background-color: #ffc107; color: black; }
        
        .info-panel {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        
        .info-heading {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-list {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        
        .info-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .info-list li:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
            text-align: right;
            word-break: break-word;
        }
        
        .step-indicator {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            color: #6c757d;
        }
        
        .env-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .task-logs-btn {
            text-decoration: none !important;
        }
        
        .task-logs-btn i {
            margin-right: 0.5rem;
        }
        
        .terminal-output {
            line-height: 1.5;
        }
        
        .command-line {
            color: #50fa7b;
            font-weight: bold;
        }
        
        .error-output {
            color: #ff5555;
        }
        
        .success-output {
            color: #50fa7b;
        }
        
        .step-header {
            color: #bd93f9;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #44475a;
            padding-bottom: 0.25rem;
        }
        
        .output-header {
            color: #8be9fd;
            font-weight: bold;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .terminal-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .terminal-actions button {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: #ccc;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .terminal-actions button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .spinner-container {
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        #environmentDetails .command-available {
            color: #50fa7b;
        }
        
        #environmentDetails .command-unavailable {
            color: #ff5555;
        }
        
        .task-controls-row {
            margin-bottom: 1rem;
        }
        
        .terminal-mode-tabs {
            margin-bottom: 1rem;
        }
        
        .terminal-mode-tabs .nav-link {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .terminal-mode-tabs .nav-link.active {
            font-weight: 600;
        }
        
        .blinking-cursor::after {
            content: '▋';
            color: #ccc;
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo" aria-label="Infinite AI Agent">
            <!-- Robot SVG Icon -->
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                <rect x="3" y="7" width="18" height="12" rx="4" fill="#343a40"/>
                <circle cx="8" cy="13" r="2" fill="#fff"/>
                <circle cx="16" cy="13" r="2" fill="#fff"/>
                <rect x="10.5" y="3" width="3" height="4" rx="1.5" fill="#343a40"/>
            </svg>
            <span>Infinite AI Agent</span>
        </div>
        <nav aria-label="Main navigation">
            <ul>
                <li><a href="/">
                    <!-- Home SVG -->
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12L12 4l9 8" stroke="#343a40" stroke-width="2" fill="none"/><path d="M5 12v7a2 2 0 002 2h2a2 2 0 002-2v-3h2v3a2 2 0 002 2h2a2 2 0 002-2v-7" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                    Home
                </a></li>
                <li><a href="/logs">
                    <!-- Logs SVG -->
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#343a40" stroke-width="2" fill="none"/><path d="M8 8h8M8 12h8M8 16h4" stroke="#343a40" stroke-width="2"/></svg>
                    System Logs
                </a></li>
                <li><a href="/history">
                    <!-- History SVG -->
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#343a40" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="#343a40" stroke-width="2"/></svg>
                    Task History
                </a></li>
            </ul>
        </nav>
    </header>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Left Column - Task Info -->
            <div class="col-lg-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0">Task Details</h2>
                </div>
                
                <div class="task-controls-row">
                    <a href="/" class="button button-secondary">
                        <!-- Left Arrow SVG -->
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 18l-6-6 6-6" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                        Back to Dashboard
                    </a>
                    <a href="/task_logs/{{ task_id }}" class="button button-secondary task-logs-btn" style="margin-left:8px;">
                        <!-- File Text SVG -->
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#343a40" stroke-width="2" fill="none"/><line x1="8" y1="8" x2="16" y2="8" stroke="#343a40" stroke-width="2"/><line x1="8" y1="12" x2="16" y2="12" stroke="#343a40" stroke-width="2"/><line x1="8" y1="16" x2="12" y2="16" stroke="#343a40" stroke-width="2"/></svg>
                        View Detailed Logs
                    </a>
                </div>
                
                <div class="info-panel">
                    <div class="info-heading" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <!-- Info SVG -->
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#343a40" stroke-width="2" fill="none"/><circle cx="12" cy="8" r="1.5" fill="#343a40"/><rect x="11" y="11" width="2" height="6" rx="1" fill="#343a40"/></svg>
                            Task Information
                        </span>
                        <span class="badge status-badge" id="taskStatusBadge">Loading...</span>
                    </div>
                    <ul class="info-list">
                        <li>
                            <span class="info-label">ID:</span>
                            <span class="info-value" id="taskId">{{ task_id }}</span>
                        </li>
                        <li>
                            <span class="info-label">Goal:</span>
                            <span class="info-value" id="taskGoal">Loading...</span>
                        </li>
                        <li>
                            <span class="info-label">Created:</span>
                            <span class="info-value" id="taskCreated">Loading...</span>
                        </li>
                        <li>
                            <span class="info-label">Duration:</span>
                            <span class="info-value" id="taskDuration">Loading...</span>
                        </li>
                        <li>
                            <span class="info-label">Current Step:</span>
                            <span class="info-value">
                                <span id="taskStep">Loading...</span>
                                <div class="spinner-container" id="stepSpinner" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </span>
                        </li>
                    </ul>
                </div>
                
                <div class="info-panel">
                    <div class="info-heading">
                        <!-- HDD SVG -->
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="7" width="18" height="10" rx="2" stroke="#343a40" stroke-width="2" fill="none"/><circle cx="8" cy="12" r="1" fill="#343a40"/><circle cx="16" cy="12" r="1" fill="#343a40"/></svg>
                        Environment
                    </div>
                    <div id="environmentDetails" class="env-list">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading environment details...</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-panel">
                    <div class="info-heading">
                        <!-- Tools SVG -->
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14.7 6.3a1 1 0 0 1 1.4 1.4l-8 8a1 1 0 0 1-1.4-1.4l8-8z" stroke="#343a40" stroke-width="2" fill="none"/><path d="M17 2l5 5-4 4-5-5z" stroke="#343a40" stroke-width="2" fill="none"/><path d="M2 22l5-5" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                        Task Controls
                    </div>
                    <div class="d-grid gap-2">
                        <button class="button button-secondary" id="refreshBtn">
                            <!-- Refresh SVG -->
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 4v6h6" stroke="#343a40" stroke-width="2" fill="none"/><path d="M20 20v-6h-6" stroke="#343a40" stroke-width="2" fill="none"/><path d="M5 19A9 9 0 1 1 19 5" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                            Refresh Status
                        </button>
                        <button class="button button-danger" id="cancelBtn" disabled>
                            <!-- X SVG -->
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#dc3545" stroke-width="2" fill="none"/><line x1="8" y1="8" x2="16" y2="16" stroke="#dc3545" stroke-width="2"/><line x1="16" y1="8" x2="8" y2="16" stroke="#dc3545" stroke-width="2"/></svg>
                            Cancel Task
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Terminal Output -->
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm">
                    <div class="card-header" style="background:#343a40; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:1rem;">
                        <h5 class="mb-0" style="display:flex; align-items:center; gap:10px;">
                            <!-- Terminal SVG -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#fff" stroke-width="2" fill="none"/><polyline points="8 9 12 13 16 9" stroke="#fff" stroke-width="2" fill="none"/></svg>
                            Task Execution
                            <span class="step-indicator" id="taskProgress">Step <span id="currentStep">0</span> of <span id="totalSteps">?</span></span>
                        </h5>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label class="auto-scroll-toggle" for="autoScrollToggle" style="color:#fff;">
                                <input type="checkbox" id="autoScrollToggle" checked style="vertical-align:middle; margin-right:4px;">
                                Auto-scroll
                            </label>
                            <button class="button button-secondary btn-icon" id="scrollToBottomBtn" title="Scroll to Bottom">
                                <!-- Down Arrow SVG -->
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="17" width="16" height="2" rx="1" fill="#fff"/><polyline points="8 13 12 17 16 13" stroke="#fff" stroke-width="2" fill="none"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="terminal-mode-tabs" style="margin-bottom:1rem;">
                            <button class="button button-secondary" id="formatted-tab" aria-controls="formatted" aria-selected="true" style="margin-right:8px;">Formatted Output</button>
                            <button class="button button-secondary" id="raw-tab" aria-controls="raw" aria-selected="false">Raw Output</button>
                        </div>
                        
                        <div id="formatted" class="tab-pane active">
                            <div class="terminal">
                                <div class="terminal-actions">
                                    <button id="copyBtn" title="Copy to clipboard" class="button button-secondary btn-icon">
                                        <!-- Clipboard SVG -->
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="7" y="3" width="10" height="4" rx="2" stroke="#343a40" stroke-width="2" fill="none"/><rect x="5" y="7" width="14" height="14" rx="2" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                                        Copy
                                    </button>
                                    <button id="downloadBtn" title="Download output" class="button button-secondary btn-icon">
                                        <!-- Download SVG -->
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="#343a40" stroke-width="2" fill="none"/><rect x="4" y="17" width="16" height="4" rx="2" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                                        Download
                                    </button>
                                    <button id="clearBtn" title="Clear terminal" class="button button-danger btn-icon">
                                        <!-- Trash SVG -->
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="6" width="18" height="15" rx="2" stroke="#dc3545" stroke-width="2" fill="none"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#dc3545" stroke-width="2" fill="none"/><line x1="10" y1="11" x2="10" y2="17" stroke="#dc3545" stroke-width="2"/><line x1="14" y1="11" x2="14" y2="17" stroke="#dc3545" stroke-width="2"/></svg>
                                        Clear
                                    </button>
                                </div>
                                <div class="terminal-output" id="terminalOutput">
                                    <div style="text-align:center; padding:3rem 0;" id="loadingOutput">
                                        <span class="loader" aria-label="Loading..."></span>
                                        <p class="task-meta">Loading task output...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="raw" class="tab-pane" style="display:none;">
                            <div class="terminal">
                                <div class="terminal-actions">
                                    <button id="rawCopyBtn" title="Copy raw output" class="button button-secondary btn-icon">
                                        <!-- Clipboard SVG -->
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="7" y="3" width="10" height="4" rx="2" stroke="#343a40" stroke-width="2" fill="none"/><rect x="5" y="7" width="14" height="14" rx="2" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                                        Copy
                                    </button>
                                    <button id="rawDownloadBtn" title="Download raw output" class="button button-secondary btn-icon">
                                        <!-- Download SVG -->
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="#343a40" stroke-width="2" fill="none"/><rect x="4" y="17" width="16" height="4" rx="2" stroke="#343a40" stroke-width="2" fill="none"/></svg>
                                        Download
                                    </button>
                                </div>
                                <pre id="rawOutput" class="mb-0">Loading raw output...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
        $(document).ready(function() {
            // Elements
            const taskId = '{{ task_id }}';
            const terminalOutput = $('#terminalOutput');
            const rawOutput = $('#rawOutput');
            const loadingOutput = $('#loadingOutput');
            const taskStatusBadge = $('#taskStatusBadge');
            const environmentDetails = $('#environmentDetails');
            const copyBtn = $('#copyBtn');
            const downloadBtn = $('#downloadBtn');
            const clearBtn = $('#clearBtn');
            const rawCopyBtn = $('#rawCopyBtn');
            const rawDownloadBtn = $('#rawDownloadBtn');
            const cancelBtn = $('#cancelBtn');
            const refreshBtn = $('#refreshBtn');
            const autoScrollToggle = $('#autoScrollToggle');
            const scrollToBottomBtn = $('#scrollToBottomBtn');
            const stepSpinner = $('#stepSpinner');
            
            // Variables
            let autoScroll = true;
            let ws = null;
            let rawOutputText = '';
            let taskCompleted = false;
            
            // Format functions
            function formatDuration(seconds) {
                if (!seconds) return 'N/A';
                
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                if (minutes === 0) {
                    return `${remainingSeconds}s`;
                } else {
                    return `${minutes}m ${remainingSeconds}s`;
                }
            }
            
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleString();
            }
            
            function getStatusBadgeClass(status) {
                if (status.includes('running') || status.includes('starting')) {
                    return 'status-running';
                } else if (status.includes('completed')) {
                    return 'status-completed';
                } else if (status.includes('failed') || status.includes('error')) {
                    return 'status-failed';
                } else if (status.includes('waiting')) {
                    return 'status-waiting';
                } else {
                    return 'bg-secondary';
                }
            }
            
            // Function to highlight terminal output
            function highlightOutput(text) {
                // Split the output by step headers
                const parts = text.split(/^---\s+Step\s+\d+\s+\([A-Z]+\)\s+---$/gm);
                const stepHeaders = text.match(/^---\s+Step\s+\d+\s+\([A-Z]+\)\s+---$/gm) || [];
                
                let formattedOutput = '';
                
                if (parts.length <= 1) {
                    // No step headers found, just return the text with error/success highlighting
                    return highlightErrorsAndSuccess(text);
                }
                
                // Process each step
                for (let i = 0; i < stepHeaders.length; i++) {
                    const header = stepHeaders[i];
                    const content = parts[i + 1] || '';
                    
                    // Add the step header
                    formattedOutput += `<div class="step-header">${header}</div>`;
                    
                    // Split the step content into code and output
                    const outputIndex = content.indexOf('--- Output ---');
                    
                    if (outputIndex !== -1) {
                        const code = content.substring(0, outputIndex).trim();
                        const output = content.substring(outputIndex + 14).trim();
                        
                        // Add the code section
                        formattedOutput += `<div class="command-line">${escapeHtml(code)}</div>`;
                        
                        // Add the output header
                        formattedOutput += `<div class="output-header">--- Output ---</div>`;
                        
                        // Add the highlighted output
                        formattedOutput += highlightErrorsAndSuccess(output);
                    } else {
                        // If we can't split it, just add the whole content
                        formattedOutput += highlightErrorsAndSuccess(content);
                    }
                }
                
                return formattedOutput;
            }
            
            // Function to highlight errors and success messages
            function highlightErrorsAndSuccess(text) {
                let html = escapeHtml(text);
                
                // Highlight error messages
                html = html.replace(/(?:^|\n)(error|exception|traceback|fail|\[erro?r?\]|❌)/gi, 
                                   (match) => `<span class="error-output">${match}</span>`);
                
                // Highlight success messages
                html = html.replace(/(?:^|\n)(success|completed|done|✅)/gi, 
                                   (match) => `<span class="success-output">${match}</span>`);
                
                // Highlight commands with $
                html = html.replace(/(?:^|\n)\$\s+(.*?)(?=\n|$)/g, 
                                   (match, cmd) => `<span class="command-line">$ ${cmd}</span>`);
                
                return html;
            }
            
            // Helper function to escape HTML
            function escapeHtml(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            
            // Function to add blinking cursor if task is still running
            function addBlinkingCursor(element, isRunning) {
                // Remove existing cursor
                element.find('.blinking-cursor').remove();
                
                // Add new cursor if task is running
                if (isRunning) {
                    element.append('<span class="blinking-cursor"></span>');
                }
            }
            
            // Function to load task details
            function loadTaskDetails() {
                $.ajax({
                    url: `/api/task/${taskId}`,
                    method: 'GET',
                    success: function(data) {
                        if (data.error) {
                            terminalOutput.html(`<div class="error-output">Error: ${data.error}</div>`);
                            rawOutput.text(`Error: ${data.error}`);
                            loadingOutput.hide();
                            return;
                        }
                        
                        // Update task info
                        $('#taskGoal').text(data.goal || 'N/A');
                        $('#taskStep').text(data.step || '0');
                        $('#currentStep').text(data.step || '0');
                        
                        // Update task status badge
                        const status = data.status || 'unknown';
                        taskStatusBadge.text(status);
                        taskStatusBadge.removeClass().addClass(`badge status-badge ${getStatusBadgeClass(status)}`);
                        
                        // Check if task is completed
                        taskCompleted = status.includes('completed') || status.includes('failed');
                        
                        // Update cancel button
                        cancelBtn.prop('disabled', taskCompleted);
                        
                        // Update created time
                        if (data.created) {
                            $('#taskCreated').text(formatDate(data.created));
                        }
                        
                        // Update duration
                        if (data.duration) {
                            $('#taskDuration').text(formatDuration(data.duration));
                        } else if (data.start_time) {
                            const duration = Math.floor(Date.now() / 1000 - data.start_time);
                            $('#taskDuration').text(formatDuration(duration) + ' (running)');
                        }
                        
                        // Show step spinner if task is running
                        if (!taskCompleted && status.includes('running')) {
                            stepSpinner.show();
                        } else {
                            stepSpinner.hide();
                        }
                        
                        // Update terminal output
                        updateTerminalOutput(data.output || '');
                        
                        // Add blinking cursor if task is still running
                        addBlinkingCursor(terminalOutput, !taskCompleted);
                        
                        // Update environment details
                        updateEnvironmentDetails(data.environment);
                    },
                    error: function(xhr, status, error) {
                        terminalOutput.html(`<div class="error-output">Error loading task: ${error}</div>`);
                        rawOutput.text(`Error loading task: ${error}`);
                        loadingOutput.hide();
                    }
                });
            }
            
            // Function to update terminal output
            function updateTerminalOutput(output) {
                if (!output) {
                    return;
                }
                
                // Store raw output
                rawOutputText = output;
                rawOutput.text(output);
                
                // Format and display terminal output
                const highlightedOutput = highlightOutput(output);
                terminalOutput.html(highlightedOutput);
                loadingOutput.hide();
                
                // Scroll to bottom if auto-scroll is enabled
                if (autoScroll) {
                    const terminal = $('.terminal');
                    terminal.scrollTop(terminal[0].scrollHeight);
                }
            }
            
            // Function to update environment details
            function updateEnvironmentDetails(env) {
                if (!env) {
                    environmentDetails.html('<div class="text-muted">No environment information available</div>');
                    return;
                }
                
                let html = '<ul class="list-group list-group-flush">';
                
                // Process user and root status
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>User</span>
                    <span>${env.user || 'unknown'} ${env.is_root ? '(root)' : ''}</span>
                </li>`;
                
                // OS info
                if (env.os_info) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>OS</span>
                        <span>${env.os_info}</span>
                    </li>`;
                }
                
                // Kernel
                if (env.kernel) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Kernel</span>
                        <span>${env.kernel}</span>
                    </li>`;
                }
                
                // Working directory
                if (env.working_dir) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Working Directory</span>
                        <span>${env.working_dir}</span>
                    </li>`;
                }
                
                // Docker status
                if (env.docker_status) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Docker</span>
                        <span>${env.docker_status}${env.docker_running ? ` (${env.docker_running})` : ''}</span>
                    </li>`;
                }
                
                // Available commands
                if (env.available_commands) {
                    html += `<li class="list-group-item">
                        <div>Available Commands</div>
                        <div class="mt-1">`;
                    
                    if (typeof env.available_commands === 'string') {
                        // Handle string format
                        const commands = env.available_commands.split(/\s+/).filter(Boolean);
                        commands.forEach(cmd => {
                            html += `<span class="badge bg-secondary me-1">${cmd}</span>`;
                        });
                    } else if (typeof env.available_commands === 'object') {
                        // Handle object format
                        for (const [cmd, status] of Object.entries(env.available_commands)) {
                            const isAvailable = status === 'available';
                            html += `<span class="badge ${isAvailable ? 'bg-success' : 'bg-danger'} me-1">${cmd}</span>`;
                        }
                    }
                    
                    html += `</div>
                    </li>`;
                }
                
                // Memory info
                if (env.memory) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Memory</span>
                        <span>${env.memory}</span>
                    </li>`;
                }
                
                // Free disk space
                if (env.free_disk_space) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Free Disk Space</span>
                        <span>${env.free_disk_space}</span>
                    </li>`;
                }
                
                html += '</ul>';
                environmentDetails.html(html);
            }
            
            // Initialize WebSocket connection
            function initWebSocket() {
                ws = new WebSocket(`ws://${window.location.host}/ws`);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'task_update' && data.id === taskId) {
                        // Update terminal output
                        updateTerminalOutput(data.output);
                        
                        // Update task status and step
                        taskStatusBadge.text(data.status);
                        taskStatusBadge.removeClass().addClass(`badge status-badge ${getStatusBadgeClass(data.status)}`);
                        
                        if (data.step) {
                            $('#taskStep').text(data.step);
                            $('#currentStep').text(data.step);
                            stepSpinner.show();
                        }
                    } else if (data.type === 'task_complete' && data.id === taskId) {
                        // Update terminal output
                        updateTerminalOutput(data.output);
                        
                        // Update task status
                        taskStatusBadge.text(data.status);
                        taskStatusBadge.removeClass().addClass(`badge status-badge ${getStatusBadgeClass(data.status)}`);
                        
                        // Update task completion
                        taskCompleted = true;
                        cancelBtn.prop('disabled', true);
                        stepSpinner.hide();
                        
                        // Remove blinking cursor
                        addBlinkingCursor(terminalOutput, false);
                        
                        // Reload task details to get final information
                        loadTaskDetails();
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    // Try to reconnect after a delay if the task is not completed
                    if (!taskCompleted) {
                        setTimeout(initWebSocket, 5000);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
            }
            
            // Copy terminal output
            copyBtn.on('click', function() {
                const text = terminalOutput.text();
                navigator.clipboard.writeText(text)
                    .then(() => {
                        const originalText = copyBtn.html();
                        copyBtn.html('<i class="bi bi-check"></i> Copied!');
                        setTimeout(() => {
                            copyBtn.html(originalText);
                        }, 2000);
                    })
                    .catch(err => {
                        alert('Failed to copy: ' + err);
                    });
            });
            
            // Copy raw output
            rawCopyBtn.on('click', function() {
                navigator.clipboard.writeText(rawOutputText)
                    .then(() => {
                        const originalText = rawCopyBtn.html();
                        rawCopyBtn.html('<i class="bi bi-check"></i> Copied!');
                        setTimeout(() => {
                            rawCopyBtn.html(originalText);
                        }, 2000);
                    })
                    .catch(err => {
                        alert('Failed to copy: ' + err);
                    });
            });
            
            // Download terminal output
            downloadBtn.on('click', function() {
                const text = terminalOutput.text();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `task_${taskId}_output.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Download raw output
            rawDownloadBtn.on('click', function() {
                const blob = new Blob([rawOutputText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `task_${taskId}_raw_output.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Clear terminal
            clearBtn.on('click', function() {
                if (confirm('Are you sure you want to clear the terminal? This will only clear the view, not the actual task output.')) {
                    terminalOutput.empty();
                }
            });
            
            // Cancel task
            cancelBtn.on('click', function() {
                if (confirm('Are you sure you want to cancel this task?')) {
                    $.ajax({
                        url: `/api/task/${taskId}/cancel`,
                        method: 'POST',
                        success: function(data) {
                            if (data.success) {
                                alert('Task cancelled successfully');
                                loadTaskDetails();
                            } else {
                                alert(`Failed to cancel task: ${data.error}`);
                            }
                        },
                        error: function(xhr, status, error) {
                            alert(`Error: ${error}`);
                        }
                    });
                }
            });
            
            // Refresh button
            refreshBtn.on('click', function() {
                loadTaskDetails();
            });
            
            // Auto-scroll toggle
            autoScrollToggle.on('change', function() {
                autoScroll = $(this).is(':checked');
                
                if (autoScroll) {
                    const terminal = $('.terminal');
                    terminal.scrollTop(terminal[0].scrollHeight);
                }
            });
            
            // Scroll to bottom button
            scrollToBottomBtn.on('click', function() {
                const terminal = $('.terminal');
                terminal.scrollTop(terminal[0].scrollHeight);
            });
            
            // Initialize
            loadTaskDetails();
            initWebSocket();
            
            // Set up auto-refresh
            const refreshInterval = setInterval(function() {
                if (!taskCompleted) {
                    loadTaskDetails();
                } else {
                    clearInterval(refreshInterval);
                }
            }, 10000);  // Refresh every 10 seconds if task is not completed
        });
    </script>
</body>
</html>